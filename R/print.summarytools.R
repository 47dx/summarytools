print.summarytools <- function(x, method="pander", silent = FALSE, report.title = NA,
                               html.header = TRUE, html.footer = TRUE, footer.note = TRUE,
                               section.title = TRUE, group.only = FALSE, 
                               file = "", append = FALSE, ...) {

  if(!method %in% c("pander", "browser", "viewer", "html"))
    stop("method must be one of 'pander', 'browser' or 'viewer'")

  # Build info.table and prepare the field  -----------------------------------

  # Function to add '#' in non-plain-ascii pander tables
  addHash <- function(string, n=4) {
    if(attr(x, "pander.args")$plain.ascii)
      string
    else
      paste(paste0(rep("#",n), collapse = ""), string)
  }
  
  if (method %in% c("browser", "viewer", "html")) {
    stpath <- find.package("summarytools")
    htmllist <- list()
    
    append_html <- function(newitem) {
      htmllist[[length(htmllist) + 1]] <<- newitem
    }
    
    build_header <- function() {
      if (isTRUE(html.header)) {
        append_html(HTML(text = "<head>"))
        append_html(tags$meta(charset="UTF-8"))
        append_html(includeCSS(path = paste(stpath,"includes/stylesheets/bootstrap.min.css", sep="/")))
        append_html(includeCSS(path = paste(stpath,"includes/stylesheets/custom.css", sep="/")))
        if(is.na(report.title)) 
          report.title <- stitle
        append_html(tags$title(report.title))        
        append_html(HTML(text = "</head>"))
        append_html(HTML(text = "<body>"))
      }
    }
    
    build_footer <- function() {
      if (isTRUE(html.footer)) {
        if (isTRUE(footer.note)) {
          fnote <- paste0("Generated by <a href='https://github.com/dcomtois/summarytools'>summarytools</a> package version ",
                          packageVersion(pkg = "summarytools"),
                          " (<a href='http://www.r-project.org/'>R</a> version ", getRversion(), ")",
                          "<br/>", Sys.Date())
          append_html(HTML(text = fnote))
        }
        append_html(HTML(text="</body></html>"))
      }
    }
  }
  
  if(attr(x, "st.type") %in% c("freq", "descr")) {
    var.info <- attr(x, "var.info")
    var.info <- var.info[!is.na(var.info)]
    
    if (isTRUE(group.only))
      var.info <- var.info[which(names(var.info)=="Group")]
    
    if(method=="pander")
      var.info <- paste(addHash(names(var.info)), var.info, sep=": ", collapse="\n")
    else
      var.info <- as.matrix(paste(names(var.info), var.info, sep=": "))
      #var.info <- paste(names(var.info), var.info, sep = ": ", collapse = ", ")
  }

  # printing freq objects -----------------------------------------------------
  if(attr(x, "st.type") == "freq") {
    stitle <- ifelse("weights" %in% names(attributes(x)),
                     "Weighted Frequencies",
                     "Frequencies")
    
    if(method == "pander") {
      if (isTRUE(section.title))
        cat("\n", addHash(stitle, 3), "\n\n", var.info, sep = "", 
            file = file, append = append)
      else 
        cat("\n", var.info, sep = "", 
            file = file, append = append)

      cat(do.call(pander::pander, append(attr(x, "pander.args"), list(x = quote(x)))), 
          file = file, append = append)
    } else {
      # method = viewer / browser  ------------------------------
      
      freq.table.html <-
        xtable::print.xtable(xtable::xtable(x = x, align = "rccccc",
                                            digits = c(0,
                                                       attr(x, "pander.args")$round * as.numeric("weights" %in% names(attributes(x))),
                                                       rep(attr(x, "pander.args")$round, 4))),
                             type = "html", print.results = FALSE,
                             html.table.attributes = 'class="table table-striped table-bordered"')
      
      build_header()
      append_html(div(class="container",
                      if (isTRUE(section.title)) 
                        h2(stitle),
                      h4(var.info),
                      #apply(var.info, 1, h4),
                      br(),
                      HTML(gsub("<td> ", "<td>", freq.table.html)))) # To avoid initial space in cells
      build_footer()
    }
  }
  
  # printing ctable objects -----------------------------------------------------
  if(attr(x, "st.type") == "ctable") {
    section.title <- "Cross-Tabulation"
    
    if(attr(x, "prop.type") %in% c("r", "c", "t")) {
      c_table <- paste0(x$ctable,
                        sub(pattern = "\\((\\d[\\.\\%])", replacement = "( \\1", 
                            x = sprintf(paste0(" (%.", attr(x, "round.digits"), "f%%)"), x$prop*100)))
      c_table <- matrix(c_table, nrow = nrow(x$ctable), 
                        dimnames = dimnames(x$ctable), byrow = FALSE)
    } else {
      c_table <- x$ctable
    }
    
    if(method == "pander") {
      if (isTRUE(section.title)) 
        cat("\n", addHash(stitle, 3), "\n")
      cat("\n", addHash(paste(names(dimnames(x$ctable)), collapse = " X "), 4), "\n",
          addHash("Proportions: ", 4), switch(attr(x, "prop.type"), r="Rows", c="Columns", t="Total"),
          sep = "", file = file, append = append)
      cat(do.call(pander::pander, append(attr(x, "pander.args"), list(x = ftable(c_table)))),
          file = file, append = append)
    } else {
      # method = viewer / browser  ------------------------------
      dnn <- names(dimnames(c_table))
      addtorow <- list()
      addtorow$pos <- list(0, 0)
      colnames(c_table)[colnames(c_table)=="<NA>"] <- "&lt;NA&gt;"
      addtorow$command <- c(paste0('<tr> <th> </th> <th colspan=', ncol(c_table)-1,'>',dnn[2],'</th><th></th></tr>'),
                            paste0('<tr> <th>', dnn[1], '</th> <th>', 
                                   paste(colnames(c_table), collapse = "</th> <th>"),
                                   '</th></tr>'))
      
      ctable.html <-
        xtable::print.xtable(xtable::xtable(x = c_table,
                                            align = paste0("r", paste(rep("c", ncol(c_table)),
                                                                      collapse=""))),
                                            #digits = c(0,rep(attr(x, "pander.args")$round,
                                            #                 ncol(x$stats)))),
                             type = "html", print.results = FALSE,
                             add.to.row = addtorow, include.colnames = FALSE,
                             html.table.attributes = 'class="table table-striped table-bordered"')

      build_header()
      append_html(div(class="container",
                      if (isTRUE(section.title))
                        h2(section.title),
                      h4(paste(names(dimnames(x$ctable)), collapse = " X ")),
                      br(),
                      HTML(gsub("<td> ", "<td>", ctable.html)))) # To avoid initial space in cells
      build_footer()
    }
  }
  
  # Printing descr objects ----------------------------------------------------
  if(attr(x, "st.type") == "descr") {

    if(!silent && "ignored" %in% names(attributes(x)))
      message("Non-numerical variable(s) ignored: ", attr(x, "ignored"))
    
    stitle <- ifelse("weights" %in% names(attributes(x)),
                     "Weighted Descriptive Statistics",
                     "Descriptive Statistics")
    
    # With method="pander" --------------------------------------
    if(method=="pander") {
      if (isTRUE(section.title))
        cat("\n", addHash(section.title, 3), "\n\n", var.info, sep = "", 
            file = file, append = append)
      else
        cat("\n", var.info, sep = "", 
            file = file, append = append)
      
      cat(do.call(pander::pander, append(attr(x, "pander.args"), list(x=quote(x$stats)))),
            file = file, append = append)
      cat(addHash("Observations"), file = file, append = append)
      cat(do.call(pander::pander, append(attr(x, "pander.args"), list(x=quote(x$observ)))),
          file = file, append = append)
    } else {
      # method = viewer / browser --------------------------
      descr.table.html <-
        xtable::print.xtable(xtable::xtable(x = x$stats,
                                            align = paste0("r", paste(rep("c",ncol(x$stats)),
                                                                     collapse="")),
                                            digits = c(0,rep(attr(x, "pander.args")$round,
                                                             ncol(x$stats)))),
                             type = "html", print.results = FALSE,
                             html.table.attributes = 'class="table table-striped table-bordered"')

      obs.table.html <-
        xtable::print.xtable(xtable::xtable(x = x$observ, align = paste0("r", paste(rep("c",ncol(x$observ)),collapse="")),
                                            digits = c(0,rep(attr(x, "pander.args")$round,ncol(x$observ)))),
                             type = "html", print.results = FALSE,
                             html.table.attributes = 'class="table table-striped table-bordered"')

      build_header()
      
      append_html(div(class="container", # style="width:80%",
                      if (isTRUE(section.title))
                        h2(section.title),
                      apply(var.info, 1, h4),
                      br(),
                      HTML(gsub("<td> ", "<td>", descr.table.html)),
                      h3("Observations"),
                      HTML(gsub("<td> ", "<td>", obs.table.html))))
      build_footer()
    }
  }

  # Printing dfSummary objects ------------------------------------------------
  if(attr(x, "st.type") == "dfSummary") {
    if(method=="pander") {
      cat("\n", addHash("Dataframe Summary", 3), "\n",
          "\n", addHash(attr(x, "df.name"), 4), "\n", sep = "", 
          file = file, append = append)
      cat(do.call(pander::pander, append(attr(x, "pander.args"), list(x=quote(x)))), 
          file = file, append = append)
    } else {
      # method = viewer / browser --------------------------------
      dfSummary.html <-
        xtable::print.xtable(xtable::xtable(x = x,digits = 0,
                                            align = paste0("c", paste(rep("l",ncol(x)),collapse=""))),
                             include.rownames = FALSE, type = "html", print.results = FALSE,
                             sanitize.colnames.function = function(x) gsub("\\.", " ", x),
                             html.table.attributes = 'class="table table-striped table-bordered"')


      build_header()
      append_html(div(class="container",
                      h3("Dataframe Summary"),
                      h2(attr(x, "df.name")),
                      if("rows.subset" %in% names(attributes(x)$var.info))
                        p("Rows subset:", attr(x,"subset")),
                      h4("Number of rows: ", attr(x, "n.obs")),
                      br(),
                      HTML(gsub("<td> ", "<td>", dfSummary.html))))
      build_footer()
    }
  }

  # Create and open the output html file --------------------------------------------
  if(method %in% c('browser', 'viewer', 'html')) {
    htmlfile <- ifelse(file == "", paste0(tempfile(),".html"), file)
    html.content <- tagList(htmllist)
    #html.content <- htmllist
    #browser()
    html.content.utf8 <- iconv(as.character(html.content), from="", to="UTF-8") # from=getOption("encoding")
    cat(html.content.utf8, file = htmlfile, append = append)
  }

  if(method=="viewer") {
    if(.Platform$GUI == "RStudio") 
      rstudioapi::viewer(htmlfile)
    else {
      message("Method 'viewer' only valid within RStudio. Switching method to 'browser'.")
      method <- "browser"
    }
  }

  # For method "browser", we don't use utils::browseURL() because of compatibility issues with RStudio
  if(method=="browser") {
    switch(Sys.info()[['sysname']],
           Windows = {shell.exec(file = paste0("file:///", htmlfile))},
           Linux   = {system(paste('/usr/bin/xdg-open', htmlfile), wait = FALSE, ignore.stdout = TRUE)},
           Darwin  = {system(paste('open', htmlfile), wait = FALSE, ignore.stderr = TRUE)})
  }

  # return file path and update tmpfiles vector when method = browser or viewer ----------------------
  if(method %in% c("browser", "viewer") && file == "") {
    if(!silent)
      message(paste0("Temporary file created: ", htmlfile, '\nTo delete, use cleartmp().'))
    .st.env$tmpfiles <- c(.st.env$tmpfiles, htmlfile)
    return(invisible(normalizePath(htmlfile)))
  } else {
    return(invisible())
  }
}
