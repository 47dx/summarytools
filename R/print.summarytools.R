print.summarytools <- function(x, method="pander", silent = FALSE, footer = FALSE,
                               file = "", append = FALSE, report.title = NA,
                               group.only = FALSE, escape.pipe = FALSE, ...) {

  if (!method %in% c("pander", "browser", "viewer"))
    stop("method must be one of 'pander', 'browser', 'viewer'")

  if (file == "" && isTRUE(append))
    stop("append is set to TRUE but no file name has been specified")

  if (file != "" && isTRUE(append) && !file.exists(file))
    stop("append is set to TRUE but specified file does not exist")

  if (file != "" && isTRUE(append) && !is.na(report.title))
    message("Appending existing file -- 'report.title' argument will be ignored")

  if (file != "" && grepl(pattern = "\\.html$", x = file, ignore.case = TRUE, perl = TRUE))
    method <- "viewer"

  # override x's attributes if any are passed as additional arguments
  argslst <- match.call()

  if ("date" %in% names(argslst))
    attr(x, "date") <- argslst$date
  if ("style" %in% names(argslst))
    attr(x, "pander_args")['style'] <- argslst$style
  if ("round" %in% names(argslst))
    attr(x, "pander_args")['round'] <- argslst$round
  if ("round.digits" %in% names(argslst))
    attr(x, "pander_args")['round'] <- argslst$round.digits
  if ("justify" %in% names(argslst))
    attr(x, "pander_args")['justify'] <- argslst$justify
  if ("plain.ascii" %in% names(argslst))
    attr(x, "pander_args")['plain.ascii'] <- argslst$plain.ascii
  if ("split.table" %in% names(argslst))
    attr(x, "pander_args")['split.table'] <- argslst$split.table
  if ("keep.trailing.zeros" %in% names(argslst))
    attr(x, "pander_args")['keep.trailing.zeros'] <- argslst$keep.trailing.zeros
  if ("Label" %in% names(argslst))
    attr(x, "var_info")['Label'] <- argslst$label
  if ("Subset" %in% names(argslst))
    attr(x, "var_info")['Subset'] <- argslst$subset
  if ("Group" %in% names(argslst))
    attr(x, "var_info")['Group'] <- argslst$group
  #attr(x, "Group") <- argslst$Group
  if ("Weights" %in% names(argslst))
    attr(x, "var_info")['Weights'] <- argslst$weights

  # When style is 'rmarkdown', make plain.ascii FALSE unless specified explicitly
  if (method == "pander" && attr(x, "pander_args")$style == 'rmarkdown' &&
      isTRUE(attr(x, "pander_args")$plain.ascii) && (!"plain.ascii" %in% (names(match.call())))) {
    attr(x, "pander_args")$plain.ascii <- FALSE
  }

  if (isTRUE(group.only) && !"Group" %in% names(attr(x, "var_info")))
    stop("group.only can only be used with objects created using by()")

  # Function to add '#' in non-plain-ascii pander tables
  add_hash <- function(str, n=4) {
    if (isTRUE(attr(x, "pander_args")$plain.ascii))
      str
    else
      paste(paste0(rep(x = "#", times = n), collapse = ""), str)
  }

  # Function to properly align numbers vertically in cells having format 99.99 (99.9 %).
  align_numbers <- function(tbl) {

    space_char <- ifelse(method %in% c("browser", "viewer"), "_", " ")

    # padleft will change "9 (99%)" to " 9 (9.9%)" if needed
    padleft <- function(str, n = 1) {
      paste0(paste(rep(space_char, n), collapse = ""), str)
    }

    # padright or "padmiddle" -- will change " 9 (9.9%)" to " 9 ( 9.9%)" if needed
    padright <- function(str, n = 1) {
      sub(pattern = "(.*\\()(.+\\))",
          replacement = paste("\\1", "\\2", sep = paste(rep(space_char, n), collapse = "")),
          x = str)
    }

    for (c in 1:ncol(tbl)) {
      pos <- max(regexpr("(", tbl[,c], fixed = TRUE))
      for (r in 1:nrow(tbl)) {
        tbl[r,c] <- padleft(tbl[r,c], n = pos - regexpr("(", tbl[r,c], fixed = TRUE))
      }

      maxlen <- max(nchar(tbl[,c]))

      for (r in 1:nrow(tbl)) {
        tbl[r,c] <- padright(tbl[r,c], n = maxlen - nchar(tbl[r,c]))
      }
    }
    return(tbl)
  }

  if (method %in% c("browser", "viewer")) {

    stpath <- find.package("summarytools")

    # build footer note
    footer_note <- paste0("Generated by <a href='https://github.com/dcomtois/summarytools'>summarytools</a> package version ",
                          packageVersion(pkg = "summarytools"),
                          " (<a href='http://www.r-project.org/'>R</a> version ", getRversion(), ")",
                          "<br/>", Sys.Date())
  }

  # Build 3 "info" elements: all_info, var_info (same as all_info but excludes by.group),
  # and Group (group-by information alone)
  if ("var_info" %in% names(attributes(x))) {
    vinfo <- attr(x, "var_info") # just to simplify coding below
    vinfo <- vinfo[!is.na(vinfo)]
    all_info <- vinfo
    var_info <- vinfo[which(names(vinfo) != "Group")]
    #var_info <- var_info[which(!is.na(var_info))]
    Group <- ifelse('Group' %in% names(vinfo), vinfo['Group'], NA)

    if(method=="pander") {
      all_info <- paste(add_hash(names(all_info)), all_info, sep=": ", collapse="\n")
      var_info <- paste(add_hash(names(var_info)), var_info, sep=": ", collapse="\n")
      if (!is.na(Group))
        Group <- paste(add_hash("Group: "), Group)
    } else {
      var_info <- paste(names(var_info), var_info, sep=": ", collapse = "<br/>")
      if (!is.na(Group))
        Group <- paste("Group: ", Group)
    }

  } else {
    # "var_info" not in names(attributes)
    all_info <- NA
    var_info <- NA
    Group <- NA
  }

  # printing freq objects -----------------------------------------------------
  if(attr(x, "st_type") == "freq") {

    # define section title
    sect_title <- ifelse("Weights" %in% names(vinfo),
                         "Weighted Frequencies",
                         "Frequencies")

    if(method == "pander") {

      output <- list()

      if (isTRUE(group.only)) {
        output[[1]] <- paste0("\n", Group)
      } else {
        output[[1]] <- paste0("\n", add_hash(sect_title, 3), "\n\n", all_info)
      }

      output[[2]] <- paste(capture.output(do.call(pander::pander,
                                                  append(attr(x, "pander_args"),
                                                         list(x = quote(x))))),
                           collapse = "\n")

      if (isTRUE(escape.pipe) && attr(x, "pander_args")$style == "grid")
        output[[2]] <- gsub("\\|","\\\\|", output[[2]])


      # method = viewer / browser  -----------------------------
    } else {

      freq_table_html <-
        xtable::print.xtable(xtable::xtable(x = x, align = "rccccc",
                                            digits = c(0,
                                                       attr(x, "pander_args")$round * as.numeric("weights" %in% names(attributes(x))),
                                                       rep(attr(x, "pander_args")$round, 4))),
                             type = "html", print.results = FALSE,
                             sanitize.rownames.function = function(x) sub(">", "&gt;", sub("<", "&lt;", x)),
                             html.table.attributes = 'class="table table-striped table-bordered"')

      freq_table_html <- gsub("<td> ", "<td>", freq_table_html)

      div_list <- list(
        if (!isTRUE(group.only))
          h2(sect_title),
        if (!isTRUE(group.only) && !is.na(var_info))
          h4(HTML(text = var_info)),
        if (!is.na(Group))
          hr(),
        if (!is.na(Group))
          h4(Group),
        HTML(text = gsub("<td> ", "<td>", freq_table_html)),
        if (isTRUE(footer))
          HTML(text = footer_note)
      )
    }
  }

  # printing ctable objects -----------------------------------------------------
  if(attr(x, "st_type") == "ctable") {

    sect_title <- "Cross-Tabulation"
    if(attr(x, "prop_type") %in% c("r", "c", "t")) {
      ctable <- paste(unlist(x$ctable),
                      sprintf(paste0("(%.", attr(x, "pander_args")$round, "f%%)"),
                              unlist(x$prop*100)))
      dim(ctable) <- dim(x$ctable)
      ctable <- align_numbers(ctable)
      dimnames(ctable) <- dimnames(x$ctable)
    } else {
      ctable <- x$ctable
    }

    if(method == "pander") {

      output <- list()

      if (isTRUE(group.only)) {
        output[[1]] <- ""
      } else {
        output[[1]] <- paste0("\n", add_hash(sect_title, 3), "\n")
      }

      output[[2]] <- paste0("\n",
                            add_hash(paste0(names(dimnames(x$ctable)), collapse = " X "), 4),
                            "\n",
                            add_hash("Proportions: ", 4),
                            switch(attr(x, "prop_type"),
                                   r="Rows",
                                   c="Columns",
                                   t="Total"))

      output[[3]] <- paste(capture.output(do.call(pander::pander,
                                                  append(attr(x, "pander_args"),
                                                         list(x = ftable(ctable))))),
                           collapse = "\n")

      if (isTRUE(escape.pipe) && attr(x, "pander_args")$style == "grid")
        output[[3]] <- gsub("\\|","\\\\|", output[[3]])

      # method = viewer / browser  ------------------------------
    } else {

      dnn <- names(dimnames(ctable))
      addtorow <- list()
      addtorow$pos <- list(0, 0)
      #colnames(ctable)[colnames(ctable) == "<NA>"] <- "&lt;NA&gt;"
      addtorow$command <- c(paste0('<tr> <th> </th> <th colspan=', ncol(ctable)-1,'>',dnn[2],'</th><th></th></tr>'),
                            paste0('<tr> <th>', dnn[1], '</th> <th>',
                                   paste(colnames(ctable), collapse = "</th> <th>"),
                                   '</th></tr>'))

      ctable_html <-
        xtable::print.xtable(xtable::xtable(x = ctable,
                                            align = paste0("r", paste(rep("c", ncol(ctable)),
                                                                      collapse=""))),
                             type = "html", print.results = FALSE,
                             add.to.row = addtorow, include.colnames = FALSE,
                             sanitize.text.function = function(x) gsub("_", "&nbsp;", x = x, fixed = TRUE),
                             sanitize.rownames.function = function(x) sub(">", "&gt;", sub("<", "&lt;", x)),
                             sanitize.colnames.function = function(x) sub(">", "&gt;", sub("<", "&lt;", x)),
                             html.table.attributes = 'class="table table-striped table-bordered monospace-cells"')

      div_list <- list(
        if (!isTRUE(group.only))
          h2(sect_title),
        if (!isTRUE(group.only) && !is.na(var_info))
          h4(HTML(text = var_info)),
        if (!is.na(Group))
          hr(),
        if (!is.na(Group))
          h4(Group),
        HTML(text = gsub("<td> ", "<td>", ctable_html)),
        if (isTRUE(footer))
          HTML(text = footer_note)
      )
    }
  }

  # Printing descr objects ----------------------------------------------------
  if(attr(x, "st_type") == "descr") {

    if(!silent && "ignored" %in% names(attributes(x)))
      message("Non-numerical variable(s) ignored: ", attr(x, "ignored"))

    sect_title <- ifelse("Weights" %in% names(vinfo),
                         "Weighted Descriptive Statistics",
                         "Descriptive Statistics")

    if(method=="pander") {

      output <- list()

      if (!isTRUE(group.only))
        output[[1]] <- paste0("\n", add_hash(sect_title, 3), "\n\n", all_info)
      else
        output[[1]] <- paste0("\n", Group)

      output[[2]] <- paste(capture.output(do.call(pander::pander,
                                                  append(attr(x, "pander_args"),
                                                         list(x=quote(x$stats))))),
                           collapse = "\n")

      output[[3]] <- paste0("\n", add_hash("Observations"))
    }


    if ("Weights" %in% names(vinfo)) {
      obstable <- paste(sprintf(paste0("%.", attr(x, "pander_args")$round, "f"),
                                unlist(x$observ)),
                        sprintf(paste0("(%.", attr(x, "pander_args")$round, "f%%)"),
                                unlist(x$observ_pct*100)))
    } else {
      obstable <- paste(unlist(x$observ),
                        sprintf(paste0("(%.", attr(x, "pander_args")$round, "f%%)"),
                                unlist(x$observ_pct*100)))
    }

    dim(obstable) <- dim(x$observ)
    dimnames(obstable) <- dimnames(x$observ)
    obstable <- align_numbers(obstable)

    if(method=="pander") {
      output[[3]] <- paste(capture.output(
        do.call(pander::pander, append(attr(x, "pander_args"),
                                       list(x=quote(obstable))))),
        collapse = "\n")

      if (isTRUE(escape.pipe) && attr(x, "pander_args")$style == "grid") {
        output[[2]] <- gsub("\\|","\\\\|", output[[2]])
        output[[3]] <- gsub("\\|","\\\\|", output[[3]])
      }
    }

    # method = viewer / browser --------------------------
    else {
      descr_table_html <-
        xtable::print.xtable(xtable::xtable(x = x$stats,
                                            align = paste0("r", paste(rep("c",ncol(x$stats)), collapse="")),
                                            digits = c(0,rep(attr(x, "pander_args")$round,
                                                             ncol(x$stats)))),
                             type = "html", print.results = FALSE,
                             html.table.attributes = 'class="table table-striped table-bordered"')

      obs_table_html <-
        xtable::print.xtable(xtable::xtable(x = obstable,
                                            align = paste0("r", paste(rep("c",ncol(x$observ)), collapse=""))),
                             type = "html", print.results = FALSE,
                             sanitize.text.function = function(x) gsub("_", "&nbsp;", x = x, fixed = TRUE),
                             sanitize.colnames.function = function(x) sub(">", "&gt;", sub("<", "&lt;", x)),
                             sanitize.rownames.function = function(x) sub(">", "&gt;", sub("<", "&lt;", x)),
                             html.table.attributes = 'class="table table-striped table-bordered monospace-cells"')

      div_list <- list(
        if (!isTRUE(group.only))
          h2(sect_title),
        if (!isTRUE(group.only) && !is.na(var_info))
          h4(HTML(text = var_info)),
        if (!is.na(Group))
          hr(),
        if (!is.na(Group))
          h4(Group),
        HTML(text = gsub("<td> ", "<td>", descr_table_html)),
        h5("Observations"),
        HTML(gsub("<td> ", "<td>", obs_table_html)),
        if (isTRUE(footer))
          HTML(text = footer_note)
      )
    }
  }

  # Printing dfSummary objects ------------------------------------------------
  if(attr(x, "st_type") == "dfSummary") {

    sect_title <- "Dataframe Summary"

    if (method == "pander") {

      output <- list()

      output[[1]] <- paste0("\n", add_hash(sect_title, 3), "\n")
      output[[2]] <- paste0("\n", add_hash(attr(x, "df_name"), 4), "\n")
      output[[3]] <- paste(capture.output(do.call(pander::pander,
                                                  append(attr(x, "pander_args"),
                                                         list(x=quote(x))))),
                           collapse = "\n")

      if (isTRUE(escape.pipe) && attr(x, "pander_args")$style == "grid")
        output[[3]] <- gsub("\\|","\\\\|", output[[3]])


      # method = viewer / browser --------------------------------
    } else {

      dfSummary_html <-
        xtable::print.xtable(xtable::xtable(x = x, digits = 0,
                                            align = paste0("c", paste(rep("l", ncol(x)), collapse=""))),
                             include.rownames = FALSE, type = "html", print.results = FALSE,
                             sanitize.colnames.function = function(x) gsub("\\.", " ", x),
                             html.table.attributes = 'class="table table-striped table-bordered"')

      div_list <- list(
        h2(sect_title),
        h3(attr(x, "df_name")),
        if("rows_subset" %in% names(attributes(x)$all_info))
          p("Rows subset:", attr(x,"subset")),
        h4("Number of rows: ", attr(x, "n_obs")),
        br(),
        HTML(gsub("<td> ", "<td>", dfSummary_html)),
        if (isTRUE(footer))
          HTML(text = footer_note)
      )
    }
  }


  # Do the actual printing or writing to file ---------------------------------------------
  if (method == "pander") {
    cat(do.call(paste, output), file = file, append = append)
    if (file != "") {
      if (isTRUE(append))
        message(paste0("Output file appended: ", file))
      else
        message(paste0("Output file written: ", file))
      return(invisible())
    }
  }

  # Put together output file content when output has html format --------------------------
  else {

    if (isTRUE(append)) {
      f <- file(file, open = "r", encoding = "utf-8")
      html_content_in <- paste(readLines(f, warn = FALSE, encoding = "utf-8"), collapse="\n")
      close(f)
      top_part <- sub("(^.+)(</body>.+)", "\\1", html_content_in)
      bottom_part <- sub("(^.+)(</body>.+)", "\\2", html_content_in)
      insert_part <- paste(capture.output(tags$div(class="container", div_list)), collapse="\n")
      html_content <- paste(capture.output(cat(top_part, insert_part, bottom_part)), collapse="\n")

    } else {

      html_content <-
        tags$div(class="container",
                 tags$head(tags$title(ifelse(is.na(report.title), sect_title, report.title)),
                           includeCSS(path = paste(stpath, "includes/stylesheets/bootstrap.min.css", sep="/")),
                           includeCSS(path = paste(stpath, "includes/stylesheets/custom.css", sep="/"))),
                 div_list
        )
    }

    outfile_path <- ifelse(file == "", paste0(tempfile(),".html"), file)

    if(isTRUE(append))
      capture.output(cat(html_content), file = outfile_path)
    else
      save_html(html = html_content, file = outfile_path)

    if (method == "viewer") {
      if (file == "" || ("open" %in% names(argslst) && isTRUE(argslst$open))) {
        if(.Platform$GUI == "RStudio")
          rstudioapi::viewer(outfile_path)
        else {
          message("Method 'viewer' only valid within RStudio. Switching method to 'browser'.")
          method <- "browser"
        }
      }
    }

    # For method "browser", we don't use utils::browseURL() because of compatibility issues with RStudio
    else if (method == "browser") {
      if (file == "" || ("open" %in% names(argslst) && isTRUE(argslst$open))) {
        switch(Sys.info()[['sysname']],
               Windows = {shell.exec(file = paste0("file:///", outfile_path))},
               Linux   = {system(paste('/usr/bin/xdg-open', outfile_path), wait = FALSE, ignore.stdout = TRUE)},
               Darwin  = {system(paste('open', outfile_path), wait = FALSE, ignore.stderr = TRUE)})
      }
    }

    # return file path and update tmpfiles vector when method = browser or viewer ----------------------
    if(file == "" && method %in% c("browser", "viewer")) {
      .st_env$tmpfiles <- c(.st_env$tmpfiles, outfile_path)
      if(!silent)
        message(paste0("Temporary file created: ", outfile_path, '\nTo delete, use cleartmp().'))
      return(invisible(normalizePath(outfile_path, winslash = "\\", mustWork = FALSE)))
    } else if (file != "") {
      if (isTRUE(append))
        message(paste0("Output file appended: ", outfile_path))
      else
        message(paste0("Output file written: ", outfile_path))
      return(invisible())
    }
  }
}
